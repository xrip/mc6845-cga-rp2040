BOM 
5x SN74LVC8T245
1x MC6845
1x RP2040
3x ATF16V8
1x ATF20V8
1x 74HC165 (LS?)
2x 6164
1x 27C32
1x 74HC373

# CGA Homebrew adapter
Состоит из 4 основных логических блоков.

## Блок видеопамяти. 

Взаимодействует с ISA шиной напрямую. Состоит из 2x 6164, 1xATF16(прошивка @pld/isa-vram.pld) и 5х SN74LVC8T245. ATF16 (isa-vram.pld) дешифрует адреса и отдает сигналы на SN74LVC8T245 и микросхемы RAM 6164. 

управляющие сигналы подключены через свободные 4 бита на второй SN74LVC8T245 чтобы не конфликтовать с управляющими сигналами от MC6845

**Карта памяти:**
*   **U1 (SRAM 1):** Будет отвечать за первые 8 КБ видеопамяти, адреса `B8000h` - `B9FFFh`.
*   **U2 (SRAM 2):** Будет отвечать за вторые 8 КБ, адреса `BA000h` - `BBFFFh`.

Шина данных (D0-D7): подключена к D0..D7 шине ISA через SN74LVC8T245. Подключена к шине данных логики CGA.
Шина адреса (A0-A12): подключена к A0..A12 шине ISA через 2х SN74LVC8T245. Через другие 2x SN74LVC8T245 к MA0-MA12 MC6845.
Сигналы /CE1 для U1 и /CE2 для U2 и общие /OE /WR подключены:
К SN74LVC8T245 со свободными пинами от ISA шины всеми 4 пинами к ATF16 (isa-vram.pld)
К SN74LVC8T245 со свободными пинами от MC6845 -- необходимо через какой то из оставшихся ATF организовать переключение /CE1 и /CE2 на основе RA0 от МС6845 учитывая бит-признаг графический/текстовый режим на защелке 373


## MC6845. 
Взаимодействует с RP2040 и микросхемами RAM 6164. Линии MA0-MA12 подключены к обеим микросхемам RAM 6164. 
## RP2040. 
Используется как хранилище регистров CGA и мостиком в регистры MC6845 и управляет ATF для например переключения из графического в текстовый режим, выбор палитр и интенсивности. Она должна защелкивать свои  настройки в 74HC373, которая управляет микросхемами ATF, для выбора режима.
## Блок логики CGA.



**Подключение к ISA:**

1.  **Шина данных (D0-D7):**
    *   Выводы `D0-D7` обеих SRAM-микросхем подключаются параллельно к 8-битной шине данных видеопамяти и ISA шине.

2.  **Шина адреса (A0-A12):**
    *  Выводы `A0-A12` обеих SRAM-микросхем подключаются параллельно к выходам `MA0-MA12` контроллера MC6845. A13 
       Это обеспечивает 13 адресных линий для доступа к 8192 ячейкам внутри каждой микросхемы.

3.  **Логика выбора микросхем (Chip Select):**
    *   Это ключевой момент. Нам нужно активировать только одну из двух микросхем в зависимости от адреса. Для этого используется старший адресный бит **`MA13`** от MC6845.
    *   **CE микросхемы U1:** Активируется, когда `MA13 = 0`. (Адреса B8000-B9FFF).
    *   **CE микросхемы U2:** Активируется, когда `MA13 = 1`. (Адреса BA000-BBFFF).
    *   Кроме того, общий сигнал Chip Enable должен формироваться дешифратором адреса, который определяет, что процессор или MC6845 обращается к диапазону `B8000h-BBFFFh`.

4.  **Сигналы управления (OE, WE):**
    *   Выводы `OE` обеих микросхем объединяются и подключаются к сигналу `MEMR` (Memory Read) системной шины.
    *   Выводы `WE` обеих микросхем объединяются и подключаются к сигналу `MEMW` (Memory Write) системной шины.

### Исправленный текст-описание с учетом SRAM

Вот как будет выглядеть ваше техническое описание, адаптированное под использование SRAM:

---

**Текстовый режим CGA**

Видеоадаптер на базе SRAM содержит 16384 байт (16 КБ) статической оперативной памяти, реализованной на двух микросхемах 8Kx8 (например, 6164). Память разделена на два банка по 8 КБ, выбираемых старшим адресным битом `MA13`.

В текстовом режиме логика чтения данных для знакогенератора и атрибутной логики остается схожей, но доступ к памяти кардинально упрощается.

1.  **Генерация адреса:** MC6845 выставляет на свои выходы `MA0..MA13` полный 14-битный адрес. Младшие 13 бит (`MA0-MA12`) определяют ячейку внутри 8-килобайтного банка, а старший бит (`MA13`) используется для выбора одной из двух микросхем SRAM.

2.  **Чтение символа и атрибута:** В текстовом режиме аппаратура CGA за один такт доступа к "символу" должна прочитать два байта. С SRAM это делается двумя последовательными быстрыми чтениями:
    *   Сначала читается байт по четному адресу (код символа).
    *   Затем читается байт по следующему нечетному адресу (атрибут символа).
        Оба байта защелкиваются в регистрах.

3.  **Формирование изображения:**
    *   Защелкнутый **код символа** и **номер строки развертки** (`RA0..RA3` от MC6845) подаются на входы **Character ROM**. На выходе ROM мы получаем 8-битную "полоску" пикселей текущего символа.
    *   Эти 8 бит загружаются в **сдвиговый регистр** (74LS166), который, тактируемый пиксельной частотой, генерирует последовательный 1-битный поток пикселей.
    *   Этот поток пикселей поступает на вход **атрибутной логики**. Эта логика также получает **атрибут символа** из защелки и, в зависимости от состояния бита пикселя (0 или 1), сигналов `DE` и `CURSOR` от MC6845, формирует итоговый 4-битный цвет (`RGBI`), который отправляется на монитор.



### 1. Роль MC6845 в графическом режиме: Ограниченное адресное пространство

В графических режимах (320x200 и 640x200) контроллер MC6845 программируется таким образом, чтобы он **никогда не генерировал адрес выше 8191**. Давайте проверим это по настройкам:

*   **Количество отображаемых "строк символов" (R6):** 100 (`0x64`)
*   **Длина одной строки в байтах:** 80 байт (40 "символов" * 2 байта/символ в режиме 320x200; 80 "символов" * 1 байт/символ в режиме 640x200)
*   **Общий объем памяти, который адресует MC6845:** 100 строк * 80 байт/строка = **8000 байт**.

Поскольку 8000 < 8192, для адресации этих данных достаточно 13 адресных линий (`MA0` - `MA12`). Следовательно, при правильной настройке для графического режима, **выход `MA13` контроллера MC6845 всегда будет неактивен (равен 0)**.

### 2. Магия внешней логики CGA: Создание физического адреса

Вот где происходит самый главный трюк. Аппаратная логика на плате CGA не просто передает адрес от MC6845 к памяти. Она **конструирует** финальный 14-битный физический адрес, комбинируя два разных типа выходов контроллера:

*   **Физический Адрес [биты 0-12]** = Выходы адреса памяти MC6845 **[MA0-MA12]**
*   **Физический Адрес [бит 13]** = Выход адреса строки развертки MC6845 **[RA0]**

Эта простая, но гениальная схема полностью меняет способ доступа к памяти:

*   **Когда MC6845 рисует четную строку (0, 2, 4...):**
    *   Его выход `RA0` равен `0`.
    *   Внешняя логика выставляет на 13-й бит физической адресной шины `0`.
    *   MC6845 генерирует последовательность адресов от 0 до 7999 на выходах `MA0-MA12`.
    *   В результате, данные считываются из диапазона адресов **B8000h - B9F3Fh** (первые 8 КБ).

*   **Когда MC6845 рисует нечетную строку (1, 3, 5...):**
    *   Его выход `RA0` равен `1`.
    *   Внешняя логика выставляет на 13-й бит физической адресной шины `1`.
    *   MC6845 генерирует **ту же самую последовательность адресов** от 0 до 7999 на выходах `MA0-MA12`.
    *   Но из-за того, что старший бит адреса теперь `1`, данные считываются из диапазона адресов **BA000h - BBF3Fh** (вторые 8 КБ, со смещением +8192).

### 3. Исправленная схема для SRAM

С учетом этого, ваша идея с заменой на две микросхемы SRAM 6164 (8Kx8) реализуется следующим образом:

1.  **Шина данных (D0-D7):** Подключаются параллельно к обеим микросхемам.
2.  **Младшая шина адреса (A0-A12):** Выходы `MA0-MA12` от MC6845 подключаются параллельно к входам `A0-A12` обеих микросхем SRAM.
3.  **Логика выбора микросхем (Chip Select):**
    *   Вход `CE` **первой** микросхемы SRAM (банк 0) активируется, когда **`RA0 = 0`**.
    *   Вход `CE` **второй** микросхемы SRAM (банк 1) активируется, когда **`RA0 = 1`**.
    *   **Выход `MA13` от MC6845 в этой схеме не используется вообще!**

