# IBM Color Graphics Adapter (CGA) - Описание регистров

## Оглавление
- [Общее описание](#общее-описание)
- [Карта портов I/O](#карта-портов-io)
- [Регистры CGA](#регистры-cga)
  - [Mode Control Register (0x3D8)](#mode-control-register-0x3d8)
  - [Color Select Register (0x3D9)](#color-select-register-0x3d9)
  - [Status Register (0x3DA)](#status-register-0x3da)
  - [Light Pen Control](#light-pen-control)
- [Видеорежимы](#видеорежимы)
- [Цветовые палитры](#цветовые-палитры)
- [Примеры использования](#примеры-использования)

---

## Общее описание

IBM Color Graphics Adapter (CGA) - адаптер цветной графики для IBM PC, использующий контроллер MC6845 для управления растром и набор собственных регистров для управления видеорежимами, цветами и палитрами.

**Основные характеристики:**
- 16 КБ видеопамяти (базовый адрес: 0xB8000)
- Поддержка текстовых режимов: 40×25 и 80×25 символов
- Поддержка графических режимов: 320×200×4 цвета, 640×200×2 цвета
- Частота работы: 7 МГц или 14 МГц (в зависимости от режима)
- 16 цветов (RGBI) в текстовом режиме
- Поддержка композитного видео и direct-drive RGB выхода

---

## Карта портов I/O

### Регистры CGA

| Адрес | Бинарный код (A9-A0) | Тип | Функция |
|-------|---------------------|-----|---------|
| 0x3D8 | 11 1101 1000 | WO  | Mode Control Register |
| 0x3D9 | 11 1101 1001 | WO  | Color Select Register |
| 0x3DA | 11 1101 1010 | RO  | Status Register |
| 0x3DB | 11 1101 1011 | WO  | Clear Light Pen Latch |
| 0x3DC | 11 1101 1100 | WO  | Preset Light Pen Latch |

### Регистры MC6845 (для справки)

| Адрес | Функция |
|-------|---------|
| 0x3D4 | 6845 Index Register (WO) |
| 0x3D5 | 6845 Data Register (R/W) |

**Обозначения:**
- WO = Write Only (только запись)
- RO = Read Only (только чтение)
- R/W = Read/Write (чтение и запись)

---

## Регистры CGA

### Mode Control Register (0x3D8)

**Тип:** Write-only, 6-bit регистр
**Назначение:** Управление видеорежимами и функциями отображения

#### Формат регистра

```
Bit:    7    6    5    4    3    2    1    0
      [---][---][BLK][HRG][VID][B/W][GRA][80]
```

#### Описание битов

| Бит | Название | Значение | Описание |
|-----|----------|----------|----------|
| 7-6 | -        | -        | Не используются |
| 5   | BLK      | 0        | 16 фоновых цветов / усиленные цвета доступны |
|     |          | 1        | Включает функцию мигания символов (только A/N режим) |
| 4   | HRG      | 0        | Нормальное разрешение |
|     |          | 1        | Высокое разрешение 640×200 ч/б графика (+ выбор 1 из 8 цветов через 0x3D9) |
| 3   | VID      | 0        | Видеосигнал отключен |
|     |          | 1        | Видеосигнал включен |
| 2   | B/W      | 0        | Цветной режим |
|     |          | 1        | Черно-белый режим |
| 1   | GRA      | 0        | Алфавитно-цифровой (текстовый) режим |
|     |          | 1        | Графический режим 320×200 |
| 0   | 80       | 0        | 40 столбцов (текстовый режим) |
|     |          | 1        | 80 столбцов (текстовый режим) |

#### Примеры комбинаций

| Биты (543210) | Режим |
|---------------|-------|
| 001001 (0x09) | 40×25 текст, черно-белый, видео включено, мигание включено |
| 001101 (0x0D) | 40×25 текст, цветной, видео включено, мигание включено |
| 001001 (0x09) | 80×25 текст, черно-белый, видео включено, мигание включено |
| 101101 (0x2D) | 80×25 текст, цветной, видео включено, мигание включено |
| 001010 (0x0A) | 320×200 графика, черно-белая, видео включено |
| 001110 (0x0E) | 320×200 графика, цветная, видео включено |
| 011010 (0x1A) | 640×200 графика, черно-белая, видео включено |

#### Важные замечания

1. **Бит 3 (VID)** должен быть сброшен в 0 перед изменением видеорежима для предотвращения визуальных артефактов
2. **Бит 5 (BLK)** в текстовом режиме:
   - `0` = атрибут бита 7 управляет интенсивностью фона (16 фоновых цветов)
   - `1` = атрибут бита 7 управляет миганием символа (8 фоновых цветов + мигание)
3. **Бит 4 (HRG)** при значении 1 переключает в режим 640×200, где каждый бит видеопамяти = 1 пиксель

---

### Color Select Register (0x3D9)

**Тип:** Write-only, 6-bit регистр
**Назначение:** Управление цветовой палитрой и цветом границы экрана

#### Формат регистра

```
Bit:    7    6    5    4    3    2    1    0
      [---][---][PAL][INT][ R ][ G ][ B ]
                           └─────┴─────┴─── Background Color / Border Color
                      └────────────────────── Intensity
                 └───────────────────────────── Palette Select
```

#### Описание битов

| Бит | Название | Функция в текстовом режиме 40×25 | Функция в графике 320×200 | Функция в графике 640×200 |
|-----|----------|----------------------------------|---------------------------|---------------------------|
| 7-6 | -        | Не используются | Не используются | Не используются |
| 5   | PAL      | - | Выбор палитры (0=Set1, 1=Set2) | - |
| 4   | INT      | Интенсивность цвета границы | Выбор альтернативной усиленной палитры / фоновые цвета | Интенсивность цвета переднего плана |
| 3   | -        | - | - | - |
| 2   | R        | Красный компонент границы | Красный компонент фона (C0=C1=00) | Красный компонент переднего плана |
| 1   | G        | Зеленый компонент границы | Зеленый компонент фона (C0=C1=00) | Зеленый компонент переднего плана |
| 0   | B        | Синий компонент границы | Синий компонент фона (C0=C1=00) | Синий компонент переднего плана |

#### Биты 3-0: Цветовые значения (IRGB)

| I | R | G | B | Цвет (нормальный) | Цвет (с интенсивностью) |
|---|---|---|---|-------------------|------------------------|
| 0 | 0 | 0 | 0 | Black | Gray |
| 0 | 0 | 0 | 1 | Blue | Light Blue |
| 0 | 0 | 1 | 0 | Green | Light Green |
| 0 | 0 | 1 | 1 | Cyan | Light Cyan |
| 0 | 1 | 0 | 0 | Red | Light Red |
| 0 | 1 | 0 | 1 | Magenta | Light Magenta |
| 0 | 1 | 1 | 0 | Brown | Yellow |
| 0 | 1 | 1 | 1 | White | White (High Intensity) |

**Примечание:** Не все мониторы распознают бит интенсивности (I).

#### Бит 5: Выбор палитры (320×200 графика)

**Палитра 0 (бит 5 = 0):**

| C1 | C0 | Цвет |
|----|----|----|
| 0  | 0  | Фоновый (биты 3-0 регистра 0x3D9) |
| 0  | 1  | Green (Зеленый) |
| 1  | 0  | Red (Красный) |
| 1  | 1  | Brown (Коричневый) / Yellow (при бите 4=1) |

**Палитра 1 (бит 5 = 1):**

| C1 | C0 | Цвет |
|----|----|----|
| 0  | 0  | Фоновый (биты 3-0 регистра 0x3D9) |
| 0  | 1  | Cyan (Циан) |
| 1  | 0  | Magenta (Пурпурный) |
| 1  | 1  | White (Белый) |

---

### Status Register (0x3DA)

**Тип:** Read-only, 4-bit регистр
**Назначение:** Получение статуса видеоадаптера и светового пера

#### Формат регистра

```
Bit:    7    6    5    4    3    2    1    0
      [---][---][---][---][VRT][PEN][PSW][DSP]
```

#### Описание битов

| Бит | Название | Значение | Описание |
|-----|----------|----------|----------|
| 7-4 | -        | -        | Не используются |
| 3   | VRT      | 0        | Активное отображение |
|     |          | 1        | Вертикальная обратная развертка (VBlank) - безопасное время для обновления экрана |
| 2   | PSW      | 0        | Переключатель светового пера нажат |
|     |          | 1        | Переключатель светового пера не нажат |
| 1   | PEN      | 0        | Световое перо не активировано |
|     |          | 1        | Световое перо обнаружило положительный фронт (триггер установлен) |
| 0   | DSP      | 0        | Обращение к видеопамяти может вызвать помехи |
|     |          | 1        | Безопасное время для обращения к видеопамяти (горизонтальная обратная развертка) |

#### Использование

```c
// Ожидание вертикальной обратной развертки
while (!(inportb(0x3DA) & 0x08));  // Ждем начала VBlank

// Ожидание окончания вертикальной обратной развертки
while (inportb(0x3DA) & 0x08);     // Ждем конца VBlank

// Проверка горизонтальной обратной развертки
if (inportb(0x3DA) & 0x01) {
    // Безопасно записывать в видеопамять
}

// Проверка светового пера
if (inportb(0x3DA) & 0x02) {
    // Световое перо активировано
}
```

#### Важные замечания

1. **Бит 0 (DSP)** - используется для предотвращения "снега" (snow) при записи в видеопамять в режиме 80×25
2. **Бит 3 (VRT)** - используется для плавной анимации и устранения мерцания
3. **Бит 2 (PSW)** - переключатель светового пера НЕ защелкивается и НЕ имеет подавления дребезга контактов
4. **Бит 1 (PEN)** - триггер сбрасывается при включении питания или командой OUT на адрес 0x3DB

---

### Light Pen Control

#### Clear Light Pen Latch (0x3DB)

**Тип:** Write-only
**Назначение:** Сброс триггера светового пера

```c
// Сброс триггера светового пера
outportb(0x3DB, 0);  // Значение не имеет значения, важен сам адрес
```

#### Preset Light Pen Latch (0x3DC)

**Тип:** Write-only
**Назначение:** Предустановка защелки светового пера

```c
// Предустановка защелки светового пера
outportb(0x3DC, 0);  // Значение не имеет значения, важен сам адрес
```

---

## Видеорежимы

### Текстовые режимы

#### 40×25 символов (Mode Control = 0x09 или 0x0D)

- **Разрешение:** 40 столбцов × 25 строк
- **Память:** 2000 байт (1000 байт символы + 1000 байт атрибуты)
- **Символьная матрица:** 8×8 пикселей
- **Частота пикселей:** 7.15909 МГц
- **Цвета:** 16 цветов переднего плана, 8 фоновых (или мигание)
- **Цвет границы:** Программируемый (регистр 0x3D9)
- **Поддержка:** Домашние телевизоры, низкое разрешение

#### 80×25 символов (Mode Control = 0x09 или 0x2D)

- **Разрешение:** 80 столбцов × 25 строк
- **Память:** 4000 байт (2000 байт символы + 2000 байт атрибуты)
- **Символьная матрица:** 8×8 пикселей
- **Частота пикселей:** 14.31818 МГц
- **Цвета:** 16 цветов переднего плана, 8 фоновых (или мигание)
- **Поддержка:** Прямой RGB вывод, композитный ч/б

### Графические режимы

#### 320×200×4 цвета (Mode Control = 0x0E)

- **Разрешение:** 320×200 пикселей
- **Память:** 16000 байт (8000 байт четные строки + 8000 байт нечетные строки)
- **Формат пикселя:** 2 бита на пиксель (4 пикселя на байт)
- **Палитры:** 2 предустановленные (Green/Red/Brown или Cyan/Magenta/White)
- **Фоновый цвет:** Любой из 16 цветов (программируется через 0x3D9)
- **Частота пикселей:** 7.15909 МГц
- **Чередование строк:** Четные строки (0, 2, 4...198) в банке 0xB8000-0xB9F3F, нечетные (1, 3, 5...199) в банке 0xBA000-0xBBF3F

**Формат байта (4 пикселя):**
```
Bit:  7  6  5  4  3  2  1  0
     [C1][C0][C1][C0][C1][C0][C1][C0]
      Pixel0  Pixel1  Pixel2  Pixel3
```

#### 640×200×2 цвета (Mode Control = 0x1A)

- **Разрешение:** 640×200 пикселей
- **Память:** 16000 байт (весь доступный буфер)
- **Формат пикселя:** 1 бит на пиксель (8 пикселей на байт)
- **Цвета:** Черно-белый (или 1 из 8 цветов через регистр 0x3D9)
- **Частота пикселей:** 14.31818 МГц
- **Чередование строк:** Аналогично 320×200 режиму

**Формат байта (8 пикселей):**
```
Bit:  7  6  5  4  3  2  1  0
     [P7][P6][P5][P4][P3][P2][P1][P0]
      Каждый бит = 1 пиксель (0=фон, 1=цвет)
```

---

## Цветовые палитры

### Текстовый режим - формат атрибутов

```
Байт атрибута:  7    6  5  4    3    2  1  0
              [BL][ Background ][I][Foreground]
```

- **Биты 0-2:** Цвет символа (передний план)
- **Бит 3:** Интенсивность символа
- **Биты 4-6:** Цвет фона
- **Бит 7:** Мигание (если бит 5 регистра 0x3D8 = 1) или интенсивность фона

#### Стандартные атрибуты

| Атрибут | Foreground | Background | Описание |
|---------|------------|------------|----------|
| 0x07    | White      | Black      | Нормальный текст |
| 0x70    | Black      | White      | Инверсный текст |
| 0x00    | Black      | Black      | Скрытый текст |
| 0x0F    | White+I    | Black      | Яркий текст |
| 0x87    | White+Blink| Black      | Мигающий текст |

### Графический режим 320×200

#### Палитра 0 (бит 5 регистра 0x3D9 = 0)

| Значение C1C0 | Цвет | RGB (примерно) |
|---------------|------|----------------|
| 00            | Background | Программируемый |
| 01            | Green | #00AA00 |
| 10            | Red | #AA0000 |
| 11            | Brown/Yellow | #AA5500 / #AAAA00 |

#### Палитра 1 (бит 5 регистра 0x3D9 = 1)

| Значение C1C0 | Цвет | RGB (примерно) |
|---------------|------|----------------|
| 00            | Background | Программируемый |
| 01            | Cyan | #00AAAA |
| 10            | Magenta | #AA00AA |
| 11            | White | #AAAAAA |

### Стандартные цвета CGA (RGBI)

| # | Цвет | IRGB | Hex | RGB (примерно) |
|---|------|------|-----|----------------|
| 0 | Black | 0000 | 0x0 | #000000 |
| 1 | Blue | 0001 | 0x1 | #0000AA |
| 2 | Green | 0010 | 0x2 | #00AA00 |
| 3 | Cyan | 0011 | 0x3 | #00AAAA |
| 4 | Red | 0100 | 0x4 | #AA0000 |
| 5 | Magenta | 0101 | 0x5 | #AA00AA |
| 6 | Brown | 0110 | 0x6 | #AA5500 |
| 7 | Light Gray | 0111 | 0x7 | #AAAAAA |
| 8 | Dark Gray | 1000 | 0x8 | #555555 |
| 9 | Light Blue | 1001 | 0x9 | #5555FF |
| 10 | Light Green | 1010 | 0xA | #55FF55 |
| 11 | Light Cyan | 1011 | 0xB | #55FFFF |
| 12 | Light Red | 1100 | 0xC | #FF5555 |
| 13 | Light Magenta | 1101 | 0xD | #FF55FF |
| 14 | Yellow | 1110 | 0xE | #FFFF55 |
| 15 | White | 1111 | 0xF | #FFFFFF |

---

## Примеры использования

### Инициализация текстового режима 80×25

```c
// Отключить видео перед изменением режима
outportb(0x3D8, 0x00);

// Запрограммировать MC6845 (см. таблицу регистров в CLAUDE.md)
// ... код программирования MC6845 ...

// Включить 80×25 цветной текстовый режим с миганием
outportb(0x3D8, 0x29);  // 00101001b: 80col + video + blink
```

### Инициализация графического режима 320×200

```c
// Отключить видео
outportb(0x3D8, 0x00);

// Запрограммировать MC6845 для графического режима
// ... код программирования MC6845 ...

// Установить фоновый цвет = синий, палитра 1 (Cyan/Magenta/White)
outportb(0x3D9, 0x21);  // 00100001b: Palette1 + Blue background

// Включить графический режим 320×200
outportb(0x3D8, 0x0E);  // 00001110b: Graphics + Color + Video
```

### Ожидание вертикальной обратной развертки

```c
void wait_vblank(void) {
    // Ждем начала VBlank
    while ((inportb(0x3DA) & 0x08) == 0);
}

void wait_display(void) {
    // Ждем окончания VBlank (начало активного отображения)
    while (inportb(0x3DA) & 0x08);
}
```

### Запись в видеопамять без "снега" (80×25)

```c
void poke_text(unsigned int offset, char ch, char attr) {
    char far *screen = (char far *)0xB8000000L;

    // Ждем горизонтальную обратную развертку
    while ((inportb(0x3DA) & 0x01) == 0);

    screen[offset * 2] = ch;

    // Ждем следующую горизонтальную обратную развертку
    while ((inportb(0x3DA) & 0x01) == 0);

    screen[offset * 2 + 1] = attr;
}
```

### Установка пикселя в режиме 320×200

```c
void set_pixel_320(int x, int y, unsigned char color) {
    unsigned int offset;
    unsigned char mask, pixel;
    char far *screen = (char far *)0xB8000000L;

    // Вычислить адрес (чередование строк)
    if (y & 1)  // Нечетная строка
        offset = 0x2000 + (y >> 1) * 80 + (x >> 2);
    else        // Четная строка
        offset = (y >> 1) * 80 + (x >> 2);

    // Вычислить позицию пикселя в байте (4 пикселя на байт)
    pixel = 3 - (x & 3);  // 3, 2, 1, 0
    mask = 0x03 << (pixel * 2);
    color = (color & 0x03) << (pixel * 2);

    // Записать пиксель
    screen[offset] = (screen[offset] & ~mask) | color;
}
```

### Изменение цвета границы (40×25)

```c
void set_border_color(unsigned char color) {
    // Цвет границы задается битами 0-3 регистра 0x3D9
    outportb(0x3D9, (inportb(0x3D9) & 0xF0) | (color & 0x0F));
}
```

### Переключение палитры (320×200)

```c
void set_palette(unsigned char palette) {
    // Palette: 0 = Green/Red/Brown, 1 = Cyan/Magenta/White
    if (palette)
        outportb(0x3D9, inportb(0x3D9) | 0x20);   // Установить бит 5
    else
        outportb(0x3D9, inportb(0x3D9) & ~0x20);  // Сбросить бит 5
}
```

### Последовательность смены видеорежима

```c
void change_video_mode(void) {
    // 1. Определить желаемый режим

    // 2. Сбросить бит video-enable
    outportb(0x3D8, 0x00);

    // 3. Запрограммировать MC6845 CRT Controller
    // ... программирование 18 регистров MC6845 ...

    // 4. Установить режим и цвета
    outportb(0x3D8, mode_control_value);   // С включенным video-enable
    outportb(0x3D9, color_select_value);
}
```

---

## Карта видеопамяти

### Текстовые режимы

**Базовый адрес:** 0xB8000

**Формат:** Чередующиеся байты символа и атрибута

```
Адрес        Содержимое
---------    -----------
0xB8000      Символ (0,0)
0xB8001      Атрибут (0,0)
0xB8002      Символ (1,0)
0xB8003      Атрибут (1,0)
...
```

**Размеры:**
- 40×25: 2000 байт (0xB8000-0xB87CF)
- 80×25: 4000 байт (0xB8000-0xB8F9F)

### Графические режимы

**Базовый адрес:** 0xB8000

**Организация:** Чередование четных и нечетных строк

```
Банк 0 (четные строки 0,2,4...198):
0xB8000 - 0xB9F3F  (8000 байт)

Банк 1 (нечетные строки 1,3,5...199):
0xBA000 - 0xBBF3F  (8000 байт)
```

**Формула адреса для пикселя (x, y):**

```c
// 320×200 режим
if (y & 1)  // Нечетная строка
    addr = 0xBA000 + (y >> 1) * 80 + (x >> 2);
else        // Четная строка
    addr = 0xB8000 + (y >> 1) * 80 + (x >> 2);

// 640×200 режим
if (y & 1)
    addr = 0xBA000 + (y >> 1) * 80 + (x >> 3);
else
    addr = 0xB8000 + (y >> 1) * 80 + (x >> 3);
```

---

## Технические характеристики

### Тактовые частоты

| Режим | Частота пикселей | Частота символов | Источник |
|-------|------------------|------------------|----------|
| 40×25 текст | 7.15909 МГц | 894886 Гц | 14.31818 МГц / 16 |
| 80×25 текст | 14.31818 МГц | 1789773 Гц | 14.31818 МГц / 8 |
| 320×200 графика | 7.15909 МГц | - | 14.31818 МГц / 2 |
| 640×200 графика | 14.31818 МГц | - | 14.31818 МГц |

**Базовая частота:** 14.31818 МГц (4 × NTSC color subcarrier = 4 × 3.579545 МГц)

### Временные характеристики

**Горизонтальная развертка:**
- 80×25: 15.75 кГц (63.5 мкс на строку)
- 40×25: 15.75 кГц (63.5 мкс на строку)

**Вертикальная развертка:**
- Частота кадров: ~60 Гц (неинтерлейсный режим)

### Разрешения

| Режим | Разрешение (символы/пикселы) | Размер символа | Эффективное разрешение |
|-------|------------------------------|----------------|------------------------|
| 40×25 текст | 40×25 символов | 8×8 пикселей | 320×200 пикселей |
| 80×25 текст | 80×25 символов | 8×8 пикселей | 640×200 пикселей |
| 320×200 графика | 320×200 пикселей | - | 320×200 пикселей |
| 640×200 графика | 640×200 пикселей | - | 640×200 пикселей |

### Память

- **Объем видеопамяти:** 16 КБ (16384 байта)
- **Тип:** Динамическая RAM без контроля четности
- **Адресное пространство:** 0xB8000 - 0xBBFFF (128 КБ зарезервировано)
- **Используемая область:** 0xB8000 - 0xBC000 (16 КБ)

---

## Совместимость и ограничения

### Известные проблемы

1. **"Снег" в режиме 80×25:**
   - Проявляется при записи в видеопамять во время активного отображения
   - Решение: использовать бит 0 регистра статуса (0x3DA) для синхронизации

2. **Композитный выход:**
   - Режим 80×25 может иметь плохую читаемость на композитных мониторах
   - Артефакты цвета при использовании ч/б композитного режима

3. **Бит интенсивности:**
   - Не все мониторы корректно отображают интенсивность (бит I)
   - На некоторых дисплеях Brown (0110) = Dark Yellow вместо Brown

### Особенности реализации

1. **Переключение режимов:**
   - Всегда сбрасывайте бит 3 (VID) перед изменением режима
   - Программируйте MC6845 перед установкой битов режима

2. **Доступ к видеопамяти:**
   - В режиме 80×25 рекомендуется синхронизация с горизонтальной развёрткой
   - В графических режимах предпочтительна синхронизация с вертикальной развёрткой

3. **Световое перо:**
   - Триггер автоматически не сбрасывается
   - Требуется программный сброс через порт 0x3DB

---

## Дополнительная информация

### Ссылки на связанные документы

- **CLAUDE.md** - Описание проекта и архитектуры системы
- **docs/MC6845.pdf** - Полная документация MC6845 CRT Controller
- **main.c** - Реализация инициализации и управления CGA
- **pld/*.pld** - Программируемая логика для обработки сигналов CGA

### Регистры MC6845 (краткая справка)

MC6845 программируется через индексный регистр (0x3D4) и регистр данных (0x3D5):

```c
// Пример записи в регистр MC6845
void mc6845_write(unsigned char reg, unsigned char value) {
    outportb(0x3D4, reg);      // Выбрать регистр
    outportb(0x3D5, value);    // Записать значение
}
```

**Основные регистры MC6845:**
- R0: Horizontal Total
- R1: Horizontal Displayed
- R2: Horizontal Sync Position
- R3: Horizontal Sync Width
- R4: Vertical Total
- R5: Vertical Total Adjust
- R6: Vertical Displayed
- R7: Vertical Sync Position
- R8: Interlace Mode
- R9: Maximum Scan Line Address
- R10-R11: Cursor configuration
- R12-R13: Start Address (High/Low)
- R14-R15: Cursor Address (High/Low)
- R16-R17: Light Pen Position (Read Only)

См. `docs/MC6845.pdf` для подробного описания регистров MC6845.

---

**Документ подготовлен:** 2025-01-XX
**Версия:** 1.0
**На основе:** IBM Color/Graphics Monitor Adapter Technical Reference (6361509)